---
title: "利用 pm2 管理 node 服務，結合 Docker Image 達到持續交付"
date: 2018-05-20T22:05:42+08:00
draft: true
author: "Jimmy Lin"
isCJKLanguage: true
tags: ["Build", "Docker"]
categories: ["DevOps"]
---

簡單來說，我們最終的目的是：**CICD + Zero Downtime 佈署 Nextjs 的服務**。其實網路上找找有蠻多方法的，像是利用 Kubernetes _(K8S)_，或是直接整合 AWS、GCP 或是 Azure，不過礙於專案不想要放到外面去，又因為 K8S 過於複雜，學習曲線太高，我們最終選擇了這個相對來說簡單許多的方式。雖然簡單但是因為之前沒有碰過 DevOps 的工作，也花了一些時間，希望這篇文章可以幫助到一些有類似需求的人。

## PM2 管理 Nextjs 服務
[PM2](http://pm2.keymetrics.io/docs/usage/quick-start/) 是一個可以用來管理 Node 服務的一個軟體，安裝方法很簡單，不僅用了 Node 裡面的 Cluter 可以根據硬體看要起幾個 Process，還可以讓多個 Service 聽同一個 port，達到 Load Balance 的效果，另外結合  [Keymetrics](https://keymetrics.io/) 還可以監控你的服務狀態，集多種功能於一身。[這篇文章](https://larrylu.blog/nodejs-pm2-cluster-455ffbd7671)簡單介紹了一下 PM2，另外也針對 Load Balance 的效能做了一些簡單的測試，值得花時間看一下。這邊我想要多加著墨的是 `ecosystem.config.js`，一個 PM2 專屬的 config 檔，藉由設定這個檔案我們可以根據不同的開發環境給予程式不同的環境變數。直接看我們使用的 `ecosystem.config.js`

```javascript
module.exports = {
  apps : [
    {
      name: 'SERVICE_NAME',
      script: '.server/index.js',
      instances: 2,
      exec_mode: 'cluster',
      log_date_format: "YYYY-MM-DD HH:mm Z",
      env: {
        NODE_ENV: 'development',
        MONGO_URL: 'mongodb://IP_ADDRESS',
        MONGO_PORT: DB_PORT_NUMBER,
        PORT: PORT_NUMBER
      },
      env_production : {
        NODE_ENV: 'production',
        MONGO_URL: 'mongodb://IP_ADDRESS',
        MONGO_PORT: DB_PORT_NUMBER,
        PORT: PORT_NUMBER
      }
    }
  ]
};
```
簡單解釋一下，pm2 起這個專案的時候，會開兩個 instance，就是跑兩個 service，都聽 `PORT_NUMBER`；專案的起始 script 是 `.server/index.js`；db 使用 MondoDB，分成 Development 和 Production 環境，會連到不同的 `IP_ADDRESS` 以及不同的 `DB_PORT_NUMBER`。上面這些設定全都可以寫在 `ecosystem.config.js` 裡面，詳細內容請看[官網](http://pm2.keymetrics.io/docs/usage/application-declaration/)。這樣在下次 service 重起的時候，會根據指令後面帶的 `--update-env` 或是 `--env production` 選擇使用不同的環境變數，官網也有針對環境變數更詳細的[解說](http://pm2.keymetrics.io/docs/usage/environment/)。根據上面的設定檔，使用下面的指令：

```bash
## 使用預設的 env 設定，也就是 NODE_ENV=development 的那組
pm2 start ecosystem.config.js 

## 使用 env_production 設定，也就是 NODE_ENV=production 的那組
pm2 start ecosystem.config.js --env production
```

## 製作 PM2 Docker Image 銜接 Nextjs 服務
PM2 團隊提供了 [Docker Integration](https://hub.docker.com/r/keymetrics/pm2/)，可以用它們所提供的 Base Image 加上一些 Build 自己專案的指令，就可以利用 Dockerfile 新增一個帶有 PM2 環境的 Image，教學寫得蠻清楚的。執行

```bash
docker run IMAGE_NAME
## 或
docker start CONTAINER_NAME
```

就可以讓你的專案藉由 PM2 來管理，可以利用

```bash
## 監看有多少個 process 正在執行
docker exec CONTAINER_NAME pm2 list
## 甚至操作所有 pm2 指令
docker exec CONTAINER_NAME pm2 --help 
```

不過我們不是用這種方法管理我們的程式的，原因是：**我們不想要把 Image 放到 Docker Cloud 上**。雖然 Build 成 Image 很方便，也可以確保每一次的更新都是一個新的 Image，不過最後還是因為隱私的關係作罷。那我們怎麼做？先看一下我們的 Dockerfile

```Dockerfile

```

## 使用 Docker Service 和 Stack 達到 Zero Downtime 部署

